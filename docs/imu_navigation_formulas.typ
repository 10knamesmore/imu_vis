= IMU 导航链路公式说明（姿态校正一致坐标系）

本说明对应后端处理链：

- 解析 `parse`
- 标定 `calibration`
- 滤波 `filter`
- 导航积分 + ZUPT `navigator`
- 输出 `output`

目标：保证姿态零位校正后，重力补偿与积分在同一参考系中进行，避免静止时速度漂移。

== 1. 符号定义

- $q_{raw}$：设备原始姿态四元数（机体系 $B \to W$）
- $q_{off}$：姿态零位校正四元数（左乘偏置）
- $q$：校正后姿态四元数
- $a_B$：机体系加速度（含重力）
- $a_W$：由姿态旋转到导航参考系后的加速度
- $g_W = (0, 0, g)$：默认世界系重力向量
- $g_{ref}$：姿态校正后，在导航参考系中使用的重力向量
- $a_{lin}$：线加速度（去重力后）
- $v, p$：速度、位置
- $Delta t$：相邻样本时间间隔

== 2. 姿态零位校正

点击“姿态校准”时，用当前姿态建立零位：

$ q_{off} = q_{raw}^{-1} $

后续每帧姿态：

$ q = q_{off} * q_{raw} $

这样在校准时刻有 $q = I$（单位四元数）。

== 3. 重力参考向量同步更新（关键）

如果只改姿态，不改重力参考系，会导致静止时出现伪线加速度。

正确做法是同时更新：

$ g_{ref} = R(q_{off}) \, g_W $

其中 $R(q)$ 表示四元数对应旋转矩阵（或等价旋转算子）。

== 4. 导航积分

每帧先把机体系加速度旋到导航参考系：

$ a_W = R(q) \, a_B $

再做重力补偿：

$ a_{lin} = a_W - g_{ref} $

离散积分（Euler）：

$ v_k = v_{k-1} + a_{lin,k} Delta t $

$ p_k = p_{k-1} + v_k Delta t $

== 5. ZUPT 约束

静止判定：

$ ||\omega|| < tau_{\omega} \quad and \quad ||a_{lin}|| < tau_a $

若判定静止：

- $v \leftarrow 0$
- $p \leftarrow p_{lock}$（静止锁定位置）

其中 $p_{lock}$ 为进入静止瞬间的位置。

== 6. 手动坐标校正（SetPosition）

手动设置位置 $p \leftarrow p_{set}$ 时，应同步：

- $v \leftarrow 0$
- 若当前静止，$p_{lock} \leftarrow p_{set}$

否则下一帧可能被旧锁定点覆盖，表现为“位置校正无效”。

== 7. 一致性约束总结

姿态校正引入新参考系后，必须满足：

- 姿态更新使用 $q_{off}$
- 重力补偿使用同一 $q_{off}$ 变换后的 $g_{ref}$
- ZUPT 的 $a_{lin}$ 与积分的 $a_{lin}$ 使用同一公式

只改其中一部分会破坏链路一致性，导致静止漂移或校正失效。
